{
    "contents" : "# power_analysis.R\n# Diana Hall\n# 8-5-2014\n# purpose: to determine what power we have in our t-test\n\n\n\nlibrary(R.matlab)\nlibrary(meadq)\n\n#current drive letter\ndrive.letter<-\"F\"\n\n#let read in data\nfilepath<-paste(drive.letter,\n                \":/EXTRAP/documents/Results/lfp_results_8-6-2014.csv\",\n                sep=\"\")\ngraphic.dir<-paste(drive.letter, \n                   \":/EXTRAP/matlab_Cina_Herr_Diana/power_analysis\",\n                  sep=\"\")\n\nskip.vector<-c(0,8,17,26,35,44,53)\nnlines=6\n\nchem.data=list()\nfor (cur.chem in 1:length(skip.vector)){\n  \n  temp<-scan(filepath, \n                            what=\"character\", \n                            sep=\",\", \n                            nlines=6, \n                            skip= skip.vector[cur.chem] )\n  temp2<-temp[temp!=\"\"]\n  temp3<-matrix(temp2, nrow=6, byrow=T);\n  nrows<-nrow(temp3); ncols<-ncol(temp3)\n  temp4<-matrix( data=as.numeric( temp3[2:nrows,2:ncols]), \n                 nrow=(nrows-1),\n                 byrow=F )\n  colnames(temp4)<-temp3[1,2:ncols]\n  rownames(temp4)<-temp3[2:nrows,1]\n  chem.name<-temp3[1,1]\n  chem.data[[ chem.name ]]<-temp4\n}\n\n# BIC\n# for a two sided one sample test\n# H0: diff=0  ie power pre & post chem is 0\n# Ha: diff<>0 ie power pre & post is different from 0\n\ndelta.vec<-c(1e-03,7e-04,3e-04,\n             1e-04,7e-05,3e-05,\n             1e-05,7e-06,3e-06,\n             1e-06,7e-07,3e-07,\n             1e-07,7e-08,3e-08,\n             1e-08,7e-09,3e-09,\n             1e-09,7e-10,3e-10,\n             1e-10,7e-11,3e-11, 1e-11)\npar(mfrow=c(5,1), mar=c(2,2,2,2), oma=c(2,2,2,2))\nfor( cur.chem in 1:length(chem.data) ){\n  \n  png( filename = paste(graphic.dir,\"/\",\n                        names(chem.data)[cur.chem],\".png\", sep=\"\")\n       )\n  par(mfrow=c(5,1), mar=c(2,2,2,2), oma=c(2,2,2,2))\n  for(cur.band in 1:5){\n  #cur.chem<-1\n  #cur.band<-1\n  data.cols<-which( !is.element( colnames(chem.data[[cur.chem]]), \n                                 c(\"t\",\"p-value\",\"sd\",\"lci\",\"uci\") )  )\n  sd.cur.chem<-sd( chem.data[[cur.chem]][ cur.band ,data.cols] )\n  \n  r<-sapply(delta.vec, function (x){\n            temp<-power.t.test(\n            n=length(data.cols ),\n                         delta=x,\n                         sig.level=0.05,\n                         power=NULL,\n                         sd = sd.cur.chem ,\n                         type=\"paired\",\n                         alternative = \"two.sided\")\n            return(temp$power)\n              }\n             )\n  power.vec<-rbind(delta.vec, r)\n\n  plot(x=log(power.vec[1,],base=10),y=power.vec[2,],\n       ylab=\"\", xlab=\"\",main = paste(rownames(chem.data[[1]])[cur.band],\n                                     \"SD=\",signif(sd.cur.chem,1) )\n        )\n  }\n  title(main=paste(\"Power \",names(chem.data)[cur.chem],\n                   \" n=\",length(data.cols),sep=\"\"),\n        xlab=\"log_10 true difference\", ylab=\"Probability of detection\",\n        line = NA, outer = T )\n  \n  dev.off()\n}\n\n\n\nytrue<-qt( p=seq(from=0.01,to=.99,length.out=length(data.cols) ),\n          df=5, lower.tail=F )\n\n#lets look at distribution of data\n\npar(mfrow=c(4,2), mar=c(2,2,2,2), oma=c(1,1,1,1))\nfor (cur.chem in 1:length(chem.data)){\n  \n  data.cols<-which( !is.element( colnames(chem.data[[cur.chem]]), \n                                 c(\"t\",\"p-value\",\"sd\",\"lci\",\"uci\") )  )\n  # qqplot(ytrue, chem.data[[cur.chem]][1,data.cols] )\n  qqnorm( chem.data[[cur.chem]][1,data.cols],\n          main=paste( names(chem.data)[cur.chem]) )\n  qqline(chem.data[[cur.chem]][1,data.cols] )\n  title(outer=T, main=\"Normal qqplot\")\n  \n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n########################################\n# prospective power analysis\n\n\nfile=\"F:/EXTRAP/matlab_Cina_Herr_Diana/finshed_data/08_26_2014_pa.mat\"\nb<-readMat(file)\n\n\npdiff.c<-c(); names.pdiff<-c()\ndiff.c<-c(); names.diff<-c()\npercents<-c(\"05per\",\"10per\",\"15per\",\"20per\",\"30per\",\"40per\",\"50per\",\"60per\")\npercents.num<-unlist(  strsplit( percents, split=\"per\" ) )\nfor (i in 1:length(b[[1]]) ){  \n  for (j in 1:length(b[[1]][[i]][[1]]) ){\n    for (k in 2:9){\n      pdiff.c<-rbind( pdiff.c, unlist( b[[1]][[i]][[1]][[j]][[k]][1:5] ) )\n    }\n    for (k in 10:17){\n      diff.c<-rbind( diff.c, unlist( b[[1]][[i]][[1]][[j]][[k]][1:5] ) )\n    }\n\n    names.pdiff<-c(names.pdiff,percents)  \n    names.diff<-c(names.diff,percents)  \n  }  \n}\nrownames(pdiff.c)<-names.pdiff\nrownames(diff.c)<-names.diff\nbands<-c(\"1-4Hz\",\"4-8Hz\",\"8-14Hz\",\"14-30Hz\",\"30-50Hz\")\ncolnames(pdiff.c)<-bands\ncolnames(diff.c)<-bands\n\n\nmean.ag<-aggregate(diff.c, by=list(rownames(diff.c)), mean )\nsd.ag<-aggregate(diff.c, by=list(rownames(diff.c)), sd )\nse.ag<-sd.ag[,-1]/sqrt(aggregate(diff.c, by=list(rownames(diff.c)), length )[,-1] )\n\n# graphs of difference between ~55 baseline chips and %105,...-%160 increase in baseline power\npar(mfrow=c(5,1), mar=c(1,2,2,0), oma=c(1,0,1.5,0))\nfor (curP in 1:length(percents) ){\n  \n  curP.num<-percents.num[curP]\n  index<-which(unlist(strsplit(rownames(diff.c), split=\"per\"))==curP.num )\n  max.x<-ceiling( log( max(diff.c[index, ]), base=10) )\n  min.x<-floor( log( min(diff.c[index, ]), base=10  ) )\n  for (curB in bands ){\n\n    hist( log( diff.c[index, curB], base=10) , breaks=50,  main= curB, \n          xlim=c(min.x ,max.x)  )\n  }\n  title(outer=T, main=paste(\"Log_10 Difference pre and \",curP.num,\"% increase\", sep=\"\"),\n        xlab=paste(curP.num,\"% increase\", sep=\"\") )\n  \n}\n\n\n# notice the tri-modality of the data. let's investigate it's causes\n\n#identify highest power mode\n# bimodality ( 1-4Hz), so cut-off 5e-07. lets use 15% change\nrows.wanted<-which(rownames(diff.c)==\"15per\")\noutlier.index<-which(diff.c[rows.wanted,1]>1.5e-07)\n\n\ntotal.curCon<-length(b[[1]])\nnfiles<-unlist(lapply(b[[1]], function(x) length(x[[1]])) )\n# 33,34,35 are the 3rd, 4th and 5th files of DA\n# 36, 37, 38 are 1st, 2nd, 3rd files of permethrin50\n# these files were all recorded on the same date and using the same culture\n\n\n# identify middle power mode of \noutlier.index<-which(diff.c[rows.wanted,1]<=1.5e-07&diff.c[rows.wanted,1]<1.5e-08)\n# H20: all files (1-10) (april and may 2014)\n# Ace: all files (11-15), (dates:june3,4, may 20,22)\n# BIC: 4th file (16-20) (dec 18), this one had low % change\n# PERM25: 2,3,4th files(21-25) SAME DAY (DEC 18)\n# Car15: 3,4,5th files (26-30)\n# DA:NONE  (31-35)\n# per50: 4th, 5th and 6th (36-41) (Same day: April, 10th 2014)\n# tri: 7th Tri (42-48) sept 26th 2013\n\n\n\n# from this output, we can conclude\n# 1. non-normal distribution means t-test inappropriate\n# 2. % control may be improvement\n\n\n\n\n\n\n\n\n\n# OUTPUT\n# we assume that sd of difference is the same in trt group and control group\n\n# arrange observed effects into a data frame\nobserved.df<-c()\nfor (chem.n in 1:length(chem.data) ){ \n  curChem<-names(chem.data)[chem.n]\n\n  cols.wanted<-(which( colnames(chem.data[[curChem]])==\"sd\")-1)\n  observed.diff<- apply( chem.data[[ curChem ]][, 1:cols.wanted ] ,1,mean) \n  observed.temp<-c(chem=curChem, n=cols.wanted, observed.diff)\n  observed.df<-rbind(observed.df, observed.temp)\n}\nrownames(observed.df)=NULL\nobserved.df<-data.frame(observed.df)\ncolnames(observed.df)[3:7]<-bands\n  \n#get effects calculated from control in data frame\ntemp1.df<-data.frame(perc=percents.num, mean.ag[,-1], sd.ag[,-1] )\ncolnames(temp1.df)<-c(\"percent\", paste(rep(\"mean\",length(bands)),bands,sep=\".\"),\n                        paste(rep(\"sd\",length(bands)),bands, sep=\".\") )\n  \n\n \n\nprint(observed.df)\nfor (curB in 1:5){\n       \n    x= temp1.df[,curB+1]; y= temp1.df[,curB+6]; temp.p<-c()\n    for( curP in 1:length(percents)){\n      \n      mean<-x[curP]; sd<-y[curP]; \n      \n      temp<-power.t.test(\n        n= NULL ,\n        delta= mean ,\n        sig.level=0.05,\n        power=.8,\n        sd = sd ,\n        type=\"paired\",\n        alternative = \"two.sided\")\n      print(temp)\n      \n    } #end of curP\n}# end of curB\n  \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
    "created" : 1408459377604.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3221200368",
    "id" : "95911821",
    "lastKnownWriteTime" : 1409096352,
    "path" : "F:/EXTRAP/matlab_Cina_Herr_Diana/power_analysis/power_analysis.R",
    "project_path" : null,
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}