{
    "contents" : "\\documentclass{article}\n\\usepackage{mathpazo}\n\\renewcommand{\\sfdefault}{lmss}\n\\renewcommand{\\ttdefault}{lmtt}\n\\usepackage[T1]{fontenc}\n\\usepackage[a4paper,left=2cm,right=4cm,top=2cm,bottom=2cm]{geometry}\n\\usepackage{setspace}\n\\usepackage{listings}\n\\usepackage{verbatim}\n\\usepackage{graphicx}\n\n\\usepackage{xspace,amsmath}\n\\newcommand{\\um}{\\ensuremath{\\mu \\text{m}}\\xspace}\n\\usepackage{url}\n\\usepackage[authoryear]{natbib}\n\\newcommand{\\dynamic}{(Dynamic)}\n\\newcommand{\\static}{(Static)}\n\\newcommand{\\hdfgroup}[1]{\\texttt{#1}}\n\n\n\\begin{document}\n\\bibliographystyle{plain}\n\\onehalfspacing\n\\title{LFP Power Anlysis and Distribution of Differences}\n\n\\author{Diana Hall}\n\\date{\\today}\n\n\\maketitle\n\n\n\\section*{ Abstract }\nThe power of a statistical test is the probability that an effect will be significant given a true underlying difference.  A power analysis was run using the experimentally derived differences as true difference, and standard deviations from the experimental results.  The results show that power is good in acetaminophen, H20, BIC, but not so powerful in permethrin 25 and 50uM, car and demoic acid.  Secondly, distributions of differences were examined for normality. Most chemicals exhibited a decent fit, but had some outiers.\n\n% * is used to remove the default numbering of sections\n\\section*{Data Preparation}\nCode obscured\n\n<<setup-1, include=FALSE, cache=FALSE, evel=F>>=\nlibrary(knitr)\n# set global chunk options\nopts_chunk$set(fig.path='figure/minimal-', fig.align='center', fig.show='hold')\noptions(replace.assign=TRUE,width=90)\n@\n\n\n<<prepare-data,eval=T,echo=F,include=FALSE>>=\n\nlibrary(R.matlab)\n\n#current drive letter\ndrive.letter<-\"E\"\n\n#let read in data on power by band by plate\nfilepath<-paste(drive.letter,\n                \":/EXTRAP/documents/Results/lfp_results_8-6-2014.csv\",\n                sep=\"\")\ngraphic.dir<-paste(drive.letter, \n                   \":/EXTRAP/matlab_Cina_Herr_Diana/power_analysis\",\n                  sep=\"\")\n#when reading in file you need to locate the particular chemical output \n# by skipping lines\nskip.vector<-c(0,8,17,26,35,44,53)\nnlines=6\n\nchem.data=list()\nfor (cur.chem in 1:length(skip.vector)){\n  \n  temp<-scan(filepath, \n                            what=\"character\", \n                            sep=\",\", \n                            nlines=6, \n                            skip= skip.vector[cur.chem] )\n  temp2<-temp[temp!=\"\"]\n  temp3<-matrix(temp2, nrow=6, byrow=T);\n  nrows<-nrow(temp3); ncols<-ncol(temp3)\n  temp4<-matrix( data=as.numeric( temp3[2:nrows,2:ncols]), \n                 nrow=(nrows-1),\n                 byrow=F )\n  colnames(temp4)<-temp3[1,2:ncols]\n  rownames(temp4)<-temp3[2:nrows,1]\n  chem.name<-temp3[1,1]\n  chem.data[[ chem.name ]]<-temp4\n}\n\n\n\n\n\n@   \n  \n\n\n\n\n\\section*{Prospective Power Analysis}\nAnother approach to power analysis is to pool all the baseline, pre-treated recordings, and inquire about the power to detect a true \\% change from baseline.\n\n\n<<prospective-power-analysis-data-gathering,eval=T,echo=F,include=T>>=\nfile=paste(drive.letter,\n           \":/EXTRAP/matlab_Cina_Herr_Diana/finshed_data/08_26_2014_pa.mat\",\n           sep=\"\")\nb<-readMat(file)\n\n\n# read in all data from matlab in terms of power\npdiff.c<-c(); names.pdiff<-c()\ndiff.c<-c(); names.diff<-c()\npercents<-c(\"05per\",\"10per\",\"15per\",\"20per\",\"30per\",\"40per\",\"50per\",\"60per\")\npercents.num<-unlist(  strsplit( percents, split=\"per\" ) )\nfor (i in 1:length(b[[1]]) ){  \n  for (j in 1:length(b[[1]][[i]][[1]]) ){\n    for (k in 2:9){\n      pdiff.c<-rbind( pdiff.c, unlist( b[[1]][[i]][[1]][[j]][[k]][1:5] ) )\n    }\n    for (k in 10:17){\n      diff.c<-rbind( diff.c, unlist( b[[1]][[i]][[1]][[j]][[k]][1:5] ) )\n    }\n\n    names.pdiff<-c(names.pdiff,percents)  \n    names.diff<-c(names.diff,percents)  \n  }  \n}\nrownames(pdiff.c)<-names.pdiff\nrownames(diff.c)<-names.diff\nbands<-c(\"1-4Hz\",\"4-8Hz\",\"8-14Hz\",\"14-30Hz\",\"30-50Hz\")\ncolnames(pdiff.c)<-bands\ncolnames(diff.c)<-bands\n\n\nmean.ag<-aggregate(diff.c, by=list(rownames(diff.c)), mean )\nsd.ag<-aggregate(diff.c, by=list(rownames(diff.c)), sd )\nse.ag<-sd.ag[,-1]/sqrt(aggregate(diff.c, by=list(rownames(diff.c)), length )[,-1] )\n\n\n\n# once we have the differences, let's derive the underlying power\n#rows of 5% change\nindex<-which(unlist(strsplit(rownames(diff.c), split=\"per\"))==\"05\" )\n#if 1.05*signal-signal=signal*0.05=diff.c then signal=diff.c/0.05\nbase.power<-diff.c[index, 1  ]/0.05\n\n#check  CORRECT\n#index.c<-which(unlist(strsplit(rownames(diff.c), split=\"per\"))==\"10\" )\n#base.power.check<-diff.c[index.c, 1 ]/0.1\n\npar(mfrow=c(5,1))\nfor ( i in 1:5){\nhist( log(base=10, diff.c[index, i  ]/0.05 ),\n      breaks=20 ,\n      main=paste(\"baseline log10 power, band \",i,\", all chips\",sep=\"\"),\n      xlab=\"log10 power\", ylab=\"count\")\n}\n\n@\n\n\n\n\n\n\n\n\n<<ppa-plots,eval=T,echo=F,include=T,>>=\npar(mfrow=c(5,1), mar=c(1,2,2,0), oma=c(1,0,1.5,0))\ncurP=3\nif (FALSE){\n#for (curP in 1:length(percents) ){\n \n\n  curP.num<-percents.num[curP]\n  index<-which(unlist(strsplit(rownames(diff.c), split=\"per\"))==curP.num )\n  max.x<-ceiling( log( max(diff.c[index, ]), base=10) )\n  min.x<-floor( log( min(diff.c[index, ]), base=10  ) )\n  for (curB in bands ){\n\n    hist( log( diff.c[index, curB], base=10) , breaks=50,  main= curB, \n          xlim=c(min.x ,max.x)  )\n  }\n  title(outer=T, main=paste(\"Log_10 Difference pre and \",curP.num,\"% increase\", sep=\"\"),\n        xlab=paste(curP.num,\"% increase\", sep=\"\") )\n  \n#}\n\n} #end if FALSE\n\n@\n\n\n\nNotice the tri-modality of the data. \n\n<<ppa-plots-mode-analysis,eval=T,echo=T,include=T>>=\nrows.wanted<-which(rownames(diff.c)==\"15per\")\n\n#mode with highest power in the first band\noutlier.index<-which(diff.c[rows.wanted,1]>1.5e-07)\n\n\ntotal.curCon<-length(b[[1]])\nnfiles<-unlist(lapply(b[[1]], function(x) length(x[[1]])) )\n\n\n# identify highest power mode of \nind.high<-outlier.index<-which(diff.c[rows.wanted,1]>1.5e-06)\nfile[33]<-\"021114 18413 DA FPSPK.mcd\" \nfile[34]<-\"021114 18416 DA FPSPK.mcd\"\nfile[35]<-\"021114 19860 DA FPSPK.mcd\" \nfile[36]<-\"021114 19857 PERM FPSPK.mcd\" \nfile[37]<-\"021114 15158 PERM FPSPK.mcd\"  \nfile[38]<-\"021114 20607 PERM FPSPK.mcd\"\nhigh.files<-file[ind.high]\n\n#middle mode in histogram\nind.mid<-outlier.index<-which(diff.c[rows.wanted,1]<=1.5e-07&diff.c[rows.wanted,1]>1.5e-08)\nfile[16]<-'090513 8395 BIC FPSPK.mcd'; \nfile[17]<-\"090513 15152 BIC FPSPK.mcd\"  \nfile[18]<-\"090513 18405 BIC FPSPK.mcd\" \nfile[20]<-\"111913 9858 BIC FPSPK.mcd\"\nfile[21]<-\"112113 18413 PERM FPSPK.mcd\"\nfile[25]<-\"111913 13079 PERM FPSPK.mcd\" \nfile[26]<-\"112113 19855 CAR FPSPK.mcd\" \nfile[27]<-\"112113 20600 CAR FPSPK.mcd\"\nfile[31]<-\"020614 15155 DA FPSPK.mcd\"\nfile[32]<-\"020614 19855 DA FPSPK.mcd\"\nfile[43]<-\"112113 18416 TRI FPSPK.mcd\"\nfile[44]<-\"111313 19861 TRI FPSPK.mcd\"\nfile[45]<-\"111413 15158 TRI FPSPK.mcd\"\nfile[46]<-\"100113 18406 TRI FPSPK.mcd\"\nfile[47]<-\"100113 20608 TRI FPSPK.mcd\"\nfile[48]<-\"092613 18412 TRI FPSPK.mcd\"\nmid.files<-file[ind.mid]\n\n\n#lowest mode of histogram\nind.low<-which(diff.c[rows.wanted,1]<1.5e-08)\nfile[1]<-\"052914 15158 CON FPSPK0001.mcd\"   \nfile[2]<-\"050114 18401 CON FPSPK0001.mcd\"  \nfile[3]<-\"052214 19855 CON FPSPK0001.mcd\"  \nfile[4]<-\"052114 19858 CON FPSPK0001.mcd\"  \nfile[5]<-\"041614 18408 CON FPSPK0001.mcd\"  \nfile[6]<-\"041614 19857 CON FPSPK0001.mcd\"  \nfile[7]<-\"052014 151223 CON FPSPK0001.mcd\" \nfile[8]<-\"052214 18395 CON FPSPK0001.mcd\" \nfile[9]<-\"052214 20613 CON FPSPK0001.mcd\" \nfile[10]<-\"052914 19861 CON FPSPK0001.mcd\"  \nfile[11]<-\"060414 20613 ACE FPSPK.mcd\"  \nfile[12]<-\"060314 13102 ACE FPSPK.mcd\"\nfile[13]<-\"060314 19861 ACE FPSPK.mcd\"  \nfile[14]<-\"052014 20596 ACE FPSPK.mcd\"\nfile[15]<-\"052214 151223 CON FPSPK.mcd\"\nfile[19]<-\"121813 18395 BIC FPSPK.mcd\"  \nfile[22]<-\"121813 19854 PERM FPSPK.mcd\"\nfile[23]<-\"121813 19398 PERM FPSPK.mcd\" \nfile[24]<-\"121813 20608 PERM FPSPK.mcd\" \nfile[28]<-\"121713 18412 CAR FPSPK.mcd\"  \nfile[29]<-\"121713 19858 CAR FPSPK.mcd\"  \nfile[30]<-\"121713 20599 CAR FPSPK.mcd\" \nfile[39]<-\"041014 9858 PERM FPSPK.mcd\"\nfile[40]<-\"041014 18400 PERM FPSPK.mcd\"\nfile[41]<-\"041014 19398 PERM FPSPK.mcd\"\nfile[42]<-\"121813 18405 TRI FPSPK.mcd\"\nlow.files<-file[ind.low]\n\n\n\n\n# lets look at distribution of dates\nlow.dates<-substring(low.files,1,6)\nmid.dates<-substring(mid.files,1,6)\nhigh.dates<-substring(high.files,1,6)\n\nlow.days<-(as.numeric( substring(low.dates, 5,6))-13)*365+\n  as.numeric( substring(low.dates, 1,2))*30.42 +\n  as.numeric( substring(low.dates,3,4))\n\nmid.days<-(as.numeric( substring(mid.dates, 5,6))-13)*365+\n  as.numeric( substring(mid.dates, 1,2) )*30.42 +\n  as.numeric( substring(mid.dates,3,4))\n\nhigh.days<-(as.numeric( substring(high.dates, 5,6))-13)*365+\n  as.numeric( substring(high.dates, 1,2))*30.42 +\n  as.numeric( substring(high.dates,3,4))\n              \ndf1<-data.frame( mode=c(rep(\"l\",length(low.dates)) ,\n             rep(\"m\", length(mid.dates)),\n             rep(\"h\", length(high.dates)) )  ,\n             day=c(low.days, mid.days,high.days) \n             )\npar(mfrow=c(1,1))\nlibrary(ggplot2)\np<-ggplot(df1, \n       aes(x=day, y=1,color=mode)) + geom_point(shape=1,size=4)+\n  ggtitle( \"Unique days of recording colored by Mode\n           day1=Jan1,2013\\n h,l,m=belongs to highest, \n           lowest and middle power mode\") \nprint(p)\n@ \n\nThis is telling us that the modality effect is primarily driven by date-culutre effect.\n\n\nLet's look at how the magnitude of the difference pre and post chemical looks on same scatter plot\n\n<<chem-data-plots,eval=T,echo=T,include=T>>=\n\n#first lets get chemical membership in each mode\nlow.chem<-unlist(lapply(strsplit(low.files, split=\" \", fixed=T), \n                        function(x) x[3] ) )\nmid.chem<-unlist(lapply(strsplit(mid.files, split=\" \", fixed=T), \n                        function(x) x[3] ) )\nhigh.chem<-unlist(lapply(strsplit(high.files, split=\" \", fixed=T), \n                         function(x) x[3] ) )\n\ndf2<-c()\n# get file names and add \"0001\" to make it match column headrs in chem.data\ntemp.files<- c(unlist(lapply(strsplit(file[1:10],split=\".\",fixed=T),\n                                 function(x) x[1])),\n                   paste(unlist( lapply(strsplit(file[-c(1:10)],split=\".\",fixed=T) ,\n                                    function(x) x[1]  )  ),\"0001\",sep=\"\") )\nfor (cur.chem in names(chem.data)){\n  pow.ind<-1:(which( names( chem.data[[cur.chem]][1,] )==\"sd\" )-1)\n  files.want<-names(chem.data[[cur.chem]][1,pow.ind])\n  #remove 0002 is some files\n  if (sum( unlist(lapply(strsplit(files.want, \n                             split=\"000\",fixed=T), \n                    function(x) x[2]) )!=1 )>0 ){\n   files.want<-unlist(lapply(strsplit(files.want, \n                       split=\"000\",fixed=T), \n              function(x) paste(x[1],\"0001\",sep=\"\")) )\n        \n    }\n    \n\n \n  #find matching file for each\n  for (cur.file in files.want){\n\n    cur.file.ind<-which( cur.file==temp.files )\n    temp.m<-c(\"l\",\"m\",\"h\")\n    cur.mode<-temp.m[c(is.element(cur.file.ind,ind.low ),\n               is.element(cur.file.ind,ind.mid ),\n               is.element(cur.file.ind,ind.high ) )]\n    \n    df2<-rbind(df2, c(cur.chem, cur.file, cur.mode) )\n  }\n  \n}\n\ndf2<-as.data.frame(df2)\nnames(df2)<-c(\"chem\", \"file\",\"mode\")\n\nlibrary(ggplot2)\np<-ggplot(df2, \n       aes(x=mode, y=file,color=chem)) + geom_point(size=4)+\n  ggtitle( \"Distribution of Chemicals among histogram mode\n           l=lowest, m=middle, h=high power mode \") \nprint(p)\n\n\n\n\n@ \nThis graph shows us that power H20 & acetaminophen is all in lowest power mode, bicuculine has one observation in lowest mode, and rest in middle mode. Carbaryl is also split and so is demoic acid.  Basically, chemicals are not evenly distributed among the different modes in their base power.\n\n\n\n\\section*{Prospective Power Analysis on Non-parametric Test}\nAs the data is not normal, a non-parametric difference of means test will be applied.\nThere are 48 chips of baseline power, and therefore 48 wells of 5, 10, 15, 20, 30, 40, 50 and 60 percent change from baseline.  \n\n<<non-parametric,eval=T,echo=T,include=T>>=\npercents.num<-unlist(  strsplit( percents, split=\"per\" ) )\ncur.per.ind=1\ncur.per<-as.numeric( percents.num[cur.per.ind] )/100\ncur.B<-1\ncur.n<-10\n\nindex.want<-which( rownames(diff.c)==percents[cur.per.ind] )\n\n# let's get the cutoff of the baseline distribution above which the true \n#   difference would be identified\n# first find the distribution of the m\n\na<-hist( log(base=10, diff.c[index.want, cur.B  ]/cur.per ),\n      breaks=30 , freq=T,  \n      main=paste(\"baseline log10 power, band \",i,\", all chips\",sep=\"\"),\n      xlab=\"log10 power\", ylab=\"count\")\n\ncur.prob<-a$counts/sum(a$counts)\nlower<-a$breaks[1:(length(a$breaks)-1) ]\nupper<-a$breaks[2:length(a$breaks) ]\n\npower.calc.5<-list()\nn.test<-c(3,4,5,6,8,seq(5,50, 5))\nfor (cur.B in 1:5){\n  \n  temp<-c(); power<-c()\n  for( cur.n in n.test ) {\n    \n    rej<-c(); \n    for (i in 1:1000){\n    \n      # get a random sample of data with replacement\n      cur.sample<-sample(1:length(lower), cur.n, prob=cur.prob, replace=T)\n      r.sample<-c()\n      for (cur.ind in unique(cur.sample)  ){\n         r.sample<-c(r.sample,\n                     runif(sum(cur.ind==cur.sample), \n                           min=lower[cur.ind], \n                           max=upper[cur.ind] ) )\n      }\n    \n      # base power\n      a<-suppressWarnings(\n        wilcox.test(x=r.sample , alternative=\"two.sided\",  mu=0) )\n      rej<-c(rej, a$p.value)\n      \n    }\n    power<-c(power, 1-(sum(rej>0.05)/length(rej) ) )\n    temp<-cbind(temp, rej)\n  \n  \n  }\n  names(power)<-paste(\"n=\", n.test,sep=\"\")\n  power.calc.5[[cur.B]]<-power\n} #done\n\n\n@ \n\nIf the baseline power across 48 chips is computed, then power is multiplied by 105 percent and a matched difference of power pre and post multiplication is taken.  The ability to detect that difference is 100 \\percent using Wilcoxon rank sum paired test and n=5,10,...50. \\newline\n\n\\section*{Percent Control Results}\n<<perc-control,eval=T,echo=T,include=T>>=\ndrive.letter<-\"E\"\n\n#let read in data on power by band by plate\nfilepath<-paste(drive.letter,\n                \":/EXTRAP/documents/Results/lfp_results_8-26-2014_%baseline.csv\",\n                sep=\"\")\n\n\nskip.vector<-2+c(0,8,17,26,35,44,53)\nnlines=6\n\ntemp<-c(); temp.names<-c()\nfor(i in 1:length(p.base)){\n  temp<-rbind(temp, cbind(p.base[[i]][,\"mean\"],\n                          p.base[[i]][,\"se\"], \n                          rep(names(p.base)[i],5 ),\n                          seq(1,5) )  )\n  \n  temp.names<-c(temp.names, c(names(p.base)[i],\n                              paste(names(p.base)[i],\"_se\",sep=\"\") ) ) \n}\ncolnames(temp)<-c(\"mean\",\"se\",\"chem\",\"band\")\ndf3<-data.frame(mean=as.numeric(as.character(temp$mean)),\n                chem=factor(temp$chem),\n                band=as.numeric(as.character(temp$band)),\n                se=as.numeric(as.character(temp$se)) )\n\nlibrary(ggplot2)\nlimits <- aes(ymax = mean + se, ymin=mean - se)\ndodge <- position_dodge(width=0.3)\np2 <- ggplot(data = df3, aes(x = band, y = mean, colour = chem)) +       \n  geom_line(aes(group = chem)) + geom_point()+\n  geom_errorbar(limits, position=dodge, width=0.25) +\n  ggtitle(\"Power % Baseline by freq. band\")\nprint(p2)\n\n\n@ \n\n\n\n\\end{document}",
    "created" : 1412008387136.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1176772947",
    "id" : "5D7D31D1",
    "lastKnownWriteTime" : 1412033219,
    "path" : "E:/EXTRAP/matlab_Cina_Herr_Diana/power_analysis/power-distribution-prospective-v2.Rnw",
    "project_path" : null,
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "sweave"
}